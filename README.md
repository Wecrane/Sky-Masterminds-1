# Sky-Masterminds 智能巡线小车

基于 **STM32F103C8** 微控制器的智能巡线小车项目，支持自动巡线和蓝牙遥控两种工作模式。

## ✨ 功能特点

- 🛤️ **自动巡线模式** - 使用5路红外传感器实现精准巡线
- 📱 **蓝牙遥控模式** - 通过蓝牙串口实现远程速度闭环控制
- ⚙️ **双闭环PID控制** - 速度环和转向环协同工作，实现平滑控制
- 📊 **OLED交互界面** - 实时显示工作状态、速度、误差和姿态角
- 🎛️ **按键操作** - 简单的按键（K1/K2）进行模式切换
- 📡 **MPU6050姿态融合** - 卡尔曼滤波解算偏航角，辅助定向
- 🛡️ **安全机制** - 支持蓝牙急停（ESTOP）指令

## 🔧 硬件配置

| 模块       | 型号/规格     | 说明                |
| ---------- | ------------- | ------------------- |
| 主控芯片   | STM32F103C8T6 | ARM Cortex-M3 内核  |
| 电机驱动   | TB6612/L298N  | 双路直流电机驱动    |
| 巡线传感器 | 5路红外传感器 | L2, L1, M, R1, R2   |
| 姿态传感器 | MPU6050       | 6轴加速度计+陀螺仪  |
| 显示屏     | 0.96寸 OLED   | I2C/SPI 接口        |
| 蓝牙模块   | HC-05/HC-06   | UART 通信 (9600bps) |
| 编码器     | 增量式编码器  | AB相测速反馈        |

## 📁 项目结构

```
Sky-Masterminds-1/
├── User/               # 用户主程序
│   └── main.c          # 主循环与逻辑调度
├── Control/            # 核心控制逻辑
│   ├── mode_control.c  # 模式管理与蓝牙协议解析
│   ├── pid.c           # PID算法实现
│   ├── element.c       # 巡线传感器数据处理
│   └── error.c         # 控制误差计算
├── Hardware/           # 硬件驱动层
│   ├── Motor.c         # 电机PWM控制
│   ├── Encoder.c       # 编码器脉冲读取
│   ├── MPU6050.c       # 陀螺仪数据读取
│   ├── OLED.c          # OLED显示驱动
│   ├── sensor.c        # 巡线传感器IO读取
│   ├── Serial.c        # 串口/蓝牙通信
│   ├── PWM.c           # 定时器PWM配置
│   ├── Key.c           # 按键扫描
│   └── kalman.c        # 姿态解算滤波
├── Library/            # STM32标准外设库
└── Project.uvprojx     # Keil MDK 工程文件
```

## 🚀 快速开始

### 1. 开发环境

- **IDE**: Keil MDK-ARM V5
- **编译器**: ARM Compiler V5 (推荐) 或 V6
- **调试器**: ST-Link V2 / J-Link / DAPLink

### 2. 操作说明

**上电校准**：
上电后会自动进入校准模式（Calibrating），此时**请保持小车静止**约2-3秒，等待陀螺仪校准完成。

**主菜单操作**：

- **K1 短按**: 进入 **巡线模式 (Line Follow)**
- **K2 短按**: 进入 **蓝牙模式 (Bluetooth)**
- **K1 长按**: 进入 **信息查看模式 (Info View)**

**模式内操作**：

- 在任何模式下，短按 **K1** or **K2** 均可退出当前模式，返回主菜单。
- 接收到蓝牙指令 `ESTOP` 会强制停止并返回主菜单。

## 📡 蓝牙控制指令

连接蓝牙串口助手（波特率 **9600**），可发送以下指令控制小车。
指令不区分大小写，支持 `\r\n` 或 `\n` 结尾。

| 指令格式   | 说明                | 示例                      |
| :--------- | :------------------ | :------------------------ |
| `FWD:速度` | 前进 (速度 0-100)   | `FWD:50` (以50的速度前进) |
| `BWD:速度` | 后退 (速度 0-100)   | `BWD:40` (以40的速度后退) |
| `TL:速度`  | 左转/原地左旋       | `TL:30` (以30的速度左转)  |
| `TR:速度`  | 右转/原地右旋       | `TR:30` (以30的速度右转)  |
| `STOP`     | 停止运动            | `STOP`                    |
| `KEY:1`    | 远程进入蓝牙模式    | `KEY:1` (相当于按下K2键)  |
| `ESTOP`    | **急停** (返回菜单) | `ESTOP` (紧急情况使用)    |

> **注意**: `速度` 对应编码器目标脉冲数，并非直接的PWM占空比，由内部速度环PID进行控制。

## Credits

开源代码参考：B站 @江科大胡不才
修改维护：Wecrane
更新日期：2026-02-05
